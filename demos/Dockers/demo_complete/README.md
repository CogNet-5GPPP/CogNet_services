# Content

This folder contains a complete demo for all cognet infrastructure

This demo is composed of two parts that are built into two different dockers

* Metrics generator 
* Machine learning processor

## Metrics generator

It is a docker that contains a python application that will push random data measures through kafka *metrics* topic each second.

### metrics_generator.py

This python based application will generate a random value between 0 and 100 for the field **test.user_perc** each two seconds and will push that value in a metrics similar json format to *metrics* topic from Kafka.

format:

```
{"metric": 
	{"timestamp": current_unix_time, "value_meta": null, "name": "test.user_perc", "value": random_value, "dimensions": 	
		{"hostname": "monasca", "service": "monitoring"}
	}, 
	"meta": 
		{"region": "useast", "tenantId": "a7c4a1ade7d040ccb1fb0d9ef4228d9e"},
	"creation_time": current_unix_time
}'
```
### Dockerfile from metrics generator

The configuration file to build the Docker.

### requirements.txt from metrics generator

python pip package requirements for Docker

## Machine learning processor

This docker will create a machine learning like python application that makes some operation over data generated by metrics generator and generates a policy output. 

Please refer to [https://github.com/CogNet-5GPPP/demos_public/tree/master/demos/Dockers/tutorial_multiple_events_with_param_variables](https://github.com/CogNet-5GPPP/demos_public/tree/master/demos/Dockers/tutorial_multiple_events_with_param_variables) to get more information about creating a Docker for machine learning processing.

### ml_multiple_params.py

This python application will read *police.json* file and push a new policy definition into *newpolicy* Kafka topic. After that it will keep listening for metrics from Kafka *metrics* topic and check if any of those metrics is the one pushed by *metrics_generator* **test.user_perc** and fill new policy occurrences with that value and some other random data to push those policies into *completetestdemo* defined by *policy.json*.

More information available at [https://github.com/CogNet-5GPPP/demos_public/tree/master/demos/Dockers/tutorial_multiple_events_with_param_variables#the-pushing-python-application](https://github.com/CogNet-5GPPP/demos_public/tree/master/demos/Dockers/tutorial_multiple_events_with_param_variables#the-pushing-python-application)

### Dockerfile from machine learning processor

The configuration file to build the Docker. More information can be found on [https://github.com/CogNet-5GPPP/demos_public/tree/master/demos/Dockers/tutorial_multiple_events_with_param_variables#creating-a-docker](https://github.com/CogNet-5GPPP/demos_public/tree/master/demos/Dockers/tutorial_multiple_events_with_param_variables#creating-a-docker)


### requirements.txt from machine learning processor

python pip package requirements for Docker

# Common elements

## ansible.yml

This playbook file is the responsible of the deployment of all neccessary content to launch the complete demo:

* Rebuild and restart metrics generator Docker
* Rebuild and restart machine learning Docker
* Wait 10 minutes 
* Stop machine learning Docker
* Send log data to user through email

There are such fields to to be filled by user:

* java_class => topicName_condition-name from policy.json from ml_processor
* field **to** from email sending system

**Please notice that there is an username and password in the email part of the ansible, these fields MUST NOT be modified. They belong to a gmail account used to send log data. YOU DON'T HAVE to put your email password in this field, just the email address where you want to receive logs**

Following there is an extract from ansible.yml where those elements are used:

```
- name: Send log to user
  hosts: docker
  vars:
    java_class: completetestdemo_threat.test_perc.high
    log_link: "http://policy/logger/export.php?op=export&uid=-1&filter=syslogtag%3A%3D{{java_class}}&exporttype=CVS"

  tasks:
    - name: download log file
      get_url: url={{log_link}} dest=/tmp/{{java_class}}.csv mode=0777

    - name: send email to user
      mail:
        host: smtp.gmail.com
        port: 587
        username: yourgmaillogaccount@gmail.com
        password: yourgmailpassword
        to: your@email.com
        subject: Ansible-report
        body: "This is a report"
        attach: /tmp/{{java_class}}.csv
```
# Deployment

## Upload content to GitHub

## Create Jenkins project

* Go to [Jenkins](http://jenkins.eu:8080/)
* New Item (Freestyle project)
* Select Git as *Source code Management*
* Add Git repository (https://github.com/CogNet-5GPPP/demos_public/)
* Set GitHub Project credentials
* Select build steps and add Invoke Ansible Playbook
* Set relative playbook file (ansible.yml) path from github
* Add **/var/lib/jenkins/workspace/CogNet_RackSpace_Infrastructure_Deploy/scripts/setup/ansible/inventory** as *Inventory File* 
* Save

## Run Jenkins Project
